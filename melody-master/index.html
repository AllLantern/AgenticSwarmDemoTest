<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melody Master - Guess the Song!</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --bg-input: #2a2a2a;
            --accent: #1db954;
            --accent-hover: #1ed760;
            --wrong: #e74c3c;
            --skip: #535353;
            --text: #ffffff;
            --text-dim: #b3b3b3;
            --text-muted: #727272;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .app {
            width: 100%;
            max-width: 500px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0 20px;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent);
        }

        .header-btns {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-card);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .icon-btn:hover { background: #333; }
        .icon-btn svg { width: 20px; height: 20px; fill: var(--text-dim); }

        /* Mode Tabs */
        .mode-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-tab {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-dim);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-tab.active {
            background: var(--accent);
            color: var(--bg-dark);
        }

        .mode-tab:hover:not(.active) { background: #333; }

        /* Progress Timeline */
        .timeline {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
        }

        .timeline-bar {
            flex: 1;
            height: 8px;
            background: var(--bg-input);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .timeline-progress {
            height: 100%;
            background: var(--accent);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .timeline-markers {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
        }

        .timeline-segment {
            height: 100%;
            border-right: 2px solid var(--bg-card);
            position: relative;
        }

        .timeline-segment.used { background: var(--wrong); }
        .timeline-segment.skipped { background: var(--skip); }
        .timeline-segment.correct { background: var(--accent); }

        .timeline-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: 12px;
            white-space: nowrap;
        }

        /* Player */
        .player {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        .waveform-container {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            margin-bottom: 20px;
        }

        .wave-bar {
            width: 4px;
            background: var(--accent);
            border-radius: 2px;
            transition: height 0.05s ease;
        }

        .play-btn {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            transition: all 0.2s;
        }

        .play-btn:hover {
            transform: scale(1.05);
            background: var(--accent-hover);
        }

        .play-btn svg {
            width: 32px;
            height: 32px;
            fill: var(--bg-dark);
            margin-left: 4px;
        }

        .play-btn.playing svg { margin-left: 0; }

        .player-info {
            margin-top: 16px;
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        .player-info strong {
            color: var(--accent);
        }

        /* Guess History */
        .guesses {
            margin-bottom: 20px;
        }

        .guess-row {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid transparent;
        }

        .guess-row.wrong { border-left-color: var(--wrong); }
        .guess-row.skipped { border-left-color: var(--skip); }
        .guess-row.correct { border-left-color: var(--accent); background: rgba(29, 185, 84, 0.1); }
        .guess-row.empty { border-left-color: var(--bg-input); opacity: 0.4; }

        .guess-num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 12px;
        }

        .guess-row.correct .guess-num { background: var(--accent); color: var(--bg-dark); }

        .guess-text {
            flex: 1;
            font-size: 0.9rem;
        }

        .guess-text.empty { color: var(--text-muted); }

        /* Input Section */
        .input-section {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid #333;
        }

        .search-wrapper {
            position: relative;
            margin-bottom: 12px;
        }

        .search-input {
            width: 100%;
            padding: 16px 20px;
            background: var(--bg-input);
            border: 2px solid transparent;
            border-radius: 12px;
            color: var(--text);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-input:focus { border-color: var(--accent); }
        .search-input::placeholder { color: var(--text-muted); }
        .search-input:disabled { opacity: 0.5; }

        .autocomplete {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-radius: 12px;
            margin-top: 8px;
            max-height: 240px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .autocomplete.show { display: block; }

        .ac-item {
            padding: 14px 20px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            transition: background 0.1s;
        }

        .ac-item:last-child { border-bottom: none; }
        .ac-item:hover, .ac-item.selected { background: var(--bg-input); }

        .ac-title { font-weight: 600; margin-bottom: 2px; }
        .ac-artist { font-size: 0.85rem; color: var(--text-dim); }

        .btn-row {
            display: flex;
            gap: 12px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .btn-skip {
            background: var(--bg-card);
            color: var(--text);
        }

        .btn-skip:hover:not(:disabled) { background: #333; }

        .btn-submit {
            background: var(--accent);
            color: var(--bg-dark);
        }

        .btn-submit:hover:not(:disabled) { background: var(--accent-hover); }

        /* Modals */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.show { display: flex; }

        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 32px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .modal h2 {
            font-size: 1.75rem;
            margin-bottom: 8px;
        }

        .modal.win h2 { color: var(--accent); }
        .modal.lose h2 { color: var(--wrong); }

        .modal-song {
            background: var(--bg-input);
            padding: 16px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .modal-song .title { font-size: 1.1rem; font-weight: 600; }
        .modal-song .artist { color: var(--text-dim); }

        .emoji-grid {
            font-size: 1.8rem;
            letter-spacing: 6px;
            margin: 16px 0;
        }

        .modal-stats {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin: 24px 0;
        }

        .stat { text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--accent); }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }

        .modal-btns {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btns .btn { padding: 14px; }

        /* Volume Control */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 16px;
            justify-content: center;
        }

        .volume-control svg { width: 20px; height: 20px; fill: var(--text-dim); }

        .volume-slider {
            width: 120px;
            height: 4px;
            -webkit-appearance: none;
            background: var(--bg-input);
            border-radius: 2px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--text);
            color: var(--bg-dark);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s;
            z-index: 2000;
        }

        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* Responsive */
        @media (max-width: 400px) {
            .modal-stats { gap: 20px; }
            .stat-value { font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="logo">ðŸŽµ Melody Master</div>
            <div class="header-btns">
                <button class="icon-btn" onclick="showStats()" title="Stats">
                    <svg viewBox="0 0 24 24"><path d="M16 11V3H8v6H2v12h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-6h4v6z"/></svg>
                </button>
                <button class="icon-btn" onclick="showHelp()" title="Help">
                    <svg viewBox="0 0 24 24"><path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/></svg>
                </button>
            </div>
        </header>

        <div class="mode-tabs">
            <button class="mode-tab active" onclick="setMode('daily')" id="tab-daily">Daily</button>
            <button class="mode-tab" onclick="setMode('practice')" id="tab-practice">Practice</button>
        </div>

        <div class="timeline">
            <div class="timeline-bar">
                <div class="timeline-progress" id="timeline-progress"></div>
                <div class="timeline-markers" id="timeline-markers"></div>
            </div>
            <div class="timeline-label" id="timeline-label">0:01</div>
        </div>

        <div class="player">
            <div class="waveform-container" id="waveform"></div>
            <button class="play-btn" id="play-btn" onclick="playSnippet()">
                <svg viewBox="0 0 24 24" id="play-icon"><polygon points="5,3 19,12 5,21"/></svg>
            </button>
            <div class="player-info">
                Attempt <strong id="attempt-num">1</strong> of 6 â€” <strong id="duration-sec">1</strong>s clip
            </div>
            <div class="volume-control">
                <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                <input type="range" class="volume-slider" id="volume" min="0" max="100" value="70" onchange="setVolume(this.value)">
            </div>
        </div>

        <div class="guesses" id="guesses"></div>

        <div class="input-section" id="input-section">
            <div class="search-wrapper">
                <input type="text" class="search-input" id="search-input" placeholder="Know it? Search for the song..." autocomplete="off">
                <div class="autocomplete" id="autocomplete"></div>
            </div>
            <div class="btn-row">
                <button class="btn btn-skip" id="btn-skip" onclick="skipGuess()">Skip (+time)</button>
                <button class="btn btn-submit" id="btn-submit" onclick="submitGuess()" disabled>Submit</button>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal-overlay" id="result-modal">
        <div class="modal" id="result-modal-content">
            <h2 id="result-title">ðŸŽ‰ You got it!</h2>
            <div class="modal-song">
                <div class="title" id="result-song-title"></div>
                <div class="artist" id="result-song-artist"></div>
            </div>
            <div class="emoji-grid" id="result-emoji"></div>
            <div class="modal-stats">
                <div class="stat">
                    <div class="stat-value" id="result-played">0</div>
                    <div class="stat-label">Played</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="result-win">0%</div>
                    <div class="stat-label">Win %</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="result-streak">0</div>
                    <div class="stat-label">Streak</div>
                </div>
            </div>
            <div class="modal-btns">
                <button class="btn btn-submit" onclick="shareResult()">Share Result</button>
                <button class="btn btn-skip" id="btn-play-again" onclick="playAgain()" style="display: none;">Play Again</button>
                <button class="btn btn-skip" onclick="closeResultModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div class="modal-overlay" id="stats-modal">
        <div class="modal">
            <h2>ðŸ“Š Statistics</h2>
            <div class="modal-stats">
                <div class="stat">
                    <div class="stat-value" id="stats-played">0</div>
                    <div class="stat-label">Played</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="stats-win">0%</div>
                    <div class="stat-label">Win %</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="stats-streak">0</div>
                    <div class="stat-label">Streak</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="stats-max">0</div>
                    <div class="stat-label">Max Streak</div>
                </div>
            </div>
            <div id="stats-distribution" style="margin: 20px 0;"></div>
            <div class="modal-btns">
                <button class="btn btn-skip" onclick="closeStatsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal">
            <h2>ðŸŽ§ How to Play</h2>
            <div style="text-align: left; margin: 20px 0; line-height: 1.8; color: var(--text-dim);">
                <p><strong style="color: var(--text);">1.</strong> Press play to hear a short clip of a melody</p>
                <p><strong style="color: var(--text);">2.</strong> Try to guess the song from the list</p>
                <p><strong style="color: var(--text);">3.</strong> Wrong guesses or skips unlock longer clips</p>
                <p><strong style="color: var(--text);">4.</strong> You have 6 attempts to guess correctly!</p>
            </div>
            <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
                <span>ðŸŸ© Correct</span>
                <span>ðŸŸ¥ Wrong</span>
                <span>â¬› Skip</span>
            </div>
            <div class="modal-btns">
                <button class="btn btn-submit" onclick="closeHelpModal()">Got it!</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
    // ===================== PIANO SYNTHESIS =====================
    // Creates realistic piano-like sounds using multiple oscillators

    class PianoSynth {
        constructor() {
            this.ctx = null;
            this.masterGain = null;
            this.volume = 0.7;
            this.activeNodes = []; // Stores {osc, gain} pairs
            this.supported = !!(window.AudioContext || window.webkitAudioContext);
        }

        init() {
            if (this.ctx) return true;
            if (!this.supported) return false;
            try {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.masterGain = this.ctx.createGain();
                this.masterGain.gain.value = this.volume;
                this.masterGain.connect(this.ctx.destination);
                return true;
            } catch (e) {
                this.supported = false;
                return false;
            }
        }

        setVolume(v) {
            this.volume = Math.max(0, Math.min(1, v)); // Clamp 0-1
            if (this.masterGain) this.masterGain.gain.value = this.volume;
        }

        stop() {
            this.activeNodes.forEach(({osc, gain}) => {
                try { osc.stop(); osc.disconnect(); gain.disconnect(); } catch(e) {}
            });
            this.activeNodes = [];
        }

        // Play a single piano note with harmonics
        playNote(freq, startTime, duration) {
            const harmonics = [1, 2, 3, 4, 5, 6];
            const gains = [1, 0.5, 0.25, 0.15, 0.1, 0.05];

            harmonics.forEach((h, i) => {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.type = i === 0 ? 'triangle' : 'sine';
                osc.frequency.value = freq * h;

                // ADSR Envelope - scale to fit note duration
                const peakGain = 0.15 * gains[i];
                const minDuration = 0.15; // Minimum for full envelope

                if (duration >= minDuration) {
                    // Full ADSR envelope
                    const attack = Math.min(0.02, duration * 0.1);
                    const decay = Math.min(0.1, duration * 0.2);
                    const release = Math.min(0.3, duration * 0.3);
                    const sustainTime = Math.max(0, duration - attack - decay - release);
                    const sustain = 0.6;

                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(peakGain, startTime + attack);
                    gain.gain.linearRampToValueAtTime(peakGain * sustain, startTime + attack + decay);
                    gain.gain.setValueAtTime(peakGain * sustain, startTime + attack + decay + sustainTime);
                    gain.gain.linearRampToValueAtTime(0, startTime + duration);
                } else {
                    // Short note: simple attack-release
                    const attack = duration * 0.3;
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(peakGain, startTime + attack);
                    gain.gain.linearRampToValueAtTime(0, startTime + duration);
                }

                osc.connect(gain);
                gain.connect(this.masterGain);

                osc.start(startTime);
                osc.stop(startTime + duration + 0.1);

                this.activeNodes.push({osc, gain});
            });
        }

        // Play melody up to maxDuration seconds
        async playMelody(melody, bpm, maxDuration) {
            if (!this.init()) return 0;
            if (this.ctx.state === 'suspended') {
                await this.ctx.resume();
            }
            this.stop();

            // Validate BPM
            if (!bpm || bpm <= 0) bpm = 120;

            const beatDuration = 60 / bpm;
            let currentTime = this.ctx.currentTime + 0.05;
            let elapsed = 0;

            for (const note of melody) {
                if (elapsed >= maxDuration) break;

                const [noteName, beats] = note;
                const noteDuration = beats * beatDuration;

                // Always advance time, even for invalid notes
                const freq = NOTE_FREQ[noteName];
                if (freq) {
                    const playDuration = Math.min(noteDuration, maxDuration - elapsed);
                    if (playDuration > 0.05) {
                        this.playNote(freq, currentTime, playDuration * 0.9);
                    }
                }

                currentTime += noteDuration;
                elapsed += noteDuration;
            }

            return Math.min(elapsed, maxDuration);
        }
    }

    // Note frequencies (extended range)
    const NOTE_FREQ = {
        'C3': 130.81, 'D3': 146.83, 'E3': 164.81, 'F3': 174.61, 'G3': 196.00, 'A3': 220.00, 'B3': 246.94,
        'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99,
        'G4': 392.00, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
        'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25, 'F5': 698.46, 'F#5': 739.99,
        'G5': 783.99, 'G#5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'B5': 987.77,
        'C6': 1046.50, 'D6': 1174.66, 'E6': 1318.51
    };

    // ===================== SONG DATABASE =====================
    // Full-length melodies (40+ notes each) - public domain songs

    const SONGS = [
        {
            id: 'twinkle',
            title: 'Twinkle Twinkle Little Star',
            artist: 'Traditional',
            category: 'Children',
            bpm: 90,
            melody: [
                ['C4', 1], ['C4', 1], ['G4', 1], ['G4', 1], ['A4', 1], ['A4', 1], ['G4', 2],
                ['F4', 1], ['F4', 1], ['E4', 1], ['E4', 1], ['D4', 1], ['D4', 1], ['C4', 2],
                ['G4', 1], ['G4', 1], ['F4', 1], ['F4', 1], ['E4', 1], ['E4', 1], ['D4', 2],
                ['G4', 1], ['G4', 1], ['F4', 1], ['F4', 1], ['E4', 1], ['E4', 1], ['D4', 2],
                ['C4', 1], ['C4', 1], ['G4', 1], ['G4', 1], ['A4', 1], ['A4', 1], ['G4', 2],
                ['F4', 1], ['F4', 1], ['E4', 1], ['E4', 1], ['D4', 1], ['D4', 1], ['C4', 2]
            ]
        },
        {
            id: 'ode-joy',
            title: 'Ode to Joy',
            artist: 'Beethoven',
            category: 'Classical',
            bpm: 120,
            melody: [
                ['E4', 1], ['E4', 1], ['F4', 1], ['G4', 1], ['G4', 1], ['F4', 1], ['E4', 1], ['D4', 1],
                ['C4', 1], ['C4', 1], ['D4', 1], ['E4', 1], ['E4', 1.5], ['D4', 0.5], ['D4', 2],
                ['E4', 1], ['E4', 1], ['F4', 1], ['G4', 1], ['G4', 1], ['F4', 1], ['E4', 1], ['D4', 1],
                ['C4', 1], ['C4', 1], ['D4', 1], ['E4', 1], ['D4', 1.5], ['C4', 0.5], ['C4', 2],
                ['D4', 1], ['D4', 1], ['E4', 1], ['C4', 1], ['D4', 1], ['E4', 0.5], ['F4', 0.5], ['E4', 1], ['C4', 1],
                ['D4', 1], ['E4', 0.5], ['F4', 0.5], ['E4', 1], ['D4', 1], ['C4', 1], ['D4', 1], ['G3', 2],
                ['E4', 1], ['E4', 1], ['F4', 1], ['G4', 1], ['G4', 1], ['F4', 1], ['E4', 1], ['D4', 1],
                ['C4', 1], ['C4', 1], ['D4', 1], ['E4', 1], ['D4', 1.5], ['C4', 0.5], ['C4', 2]
            ]
        },
        {
            id: 'happy-birthday',
            title: 'Happy Birthday',
            artist: 'Traditional',
            category: 'Celebration',
            bpm: 140,
            melody: [
                ['G4', 0.75], ['G4', 0.25], ['A4', 1], ['G4', 1], ['C5', 1], ['B4', 2],
                ['G4', 0.75], ['G4', 0.25], ['A4', 1], ['G4', 1], ['D5', 1], ['C5', 2],
                ['G4', 0.75], ['G4', 0.25], ['G5', 1], ['E5', 1], ['C5', 1], ['B4', 1], ['A4', 2],
                ['F5', 0.75], ['F5', 0.25], ['E5', 1], ['C5', 1], ['D5', 1], ['C5', 2],
                ['G4', 0.75], ['G4', 0.25], ['A4', 1], ['G4', 1], ['C5', 1], ['B4', 2],
                ['G4', 0.75], ['G4', 0.25], ['A4', 1], ['G4', 1], ['D5', 1], ['C5', 2]
            ]
        },
        {
            id: 'fur-elise',
            title: 'FÃ¼r Elise',
            artist: 'Beethoven',
            category: 'Classical',
            bpm: 130,
            melody: [
                ['E5', 0.5], ['D#5', 0.5], ['E5', 0.5], ['D#5', 0.5], ['E5', 0.5], ['B4', 0.5], ['D5', 0.5], ['C5', 0.5],
                ['A4', 1], ['C4', 0.5], ['E4', 0.5], ['A4', 0.5], ['B4', 1], ['E4', 0.5], ['G#4', 0.5], ['B4', 0.5],
                ['C5', 1], ['E4', 0.5], ['E5', 0.5], ['D#5', 0.5], ['E5', 0.5], ['D#5', 0.5], ['E5', 0.5], ['B4', 0.5], ['D5', 0.5], ['C5', 0.5],
                ['A4', 1], ['C4', 0.5], ['E4', 0.5], ['A4', 0.5], ['B4', 1], ['E4', 0.5], ['C5', 0.5], ['B4', 0.5], ['A4', 1.5],
                ['E5', 0.5], ['D#5', 0.5], ['E5', 0.5], ['D#5', 0.5], ['E5', 0.5], ['B4', 0.5], ['D5', 0.5], ['C5', 0.5],
                ['A4', 1], ['C4', 0.5], ['E4', 0.5], ['A4', 0.5], ['B4', 1], ['E4', 0.5], ['G#4', 0.5], ['B4', 0.5],
                ['C5', 1], ['E4', 0.5], ['E5', 0.5], ['D#5', 0.5], ['E5', 0.5], ['D#5', 0.5], ['E5', 0.5], ['B4', 0.5], ['D5', 0.5], ['C5', 0.5],
                ['A4', 1], ['C4', 0.5], ['E4', 0.5], ['A4', 0.5], ['B4', 1], ['E4', 0.5], ['C5', 0.5], ['B4', 0.5], ['A4', 2]
            ]
        },
        {
            id: 'jingle-bells',
            title: 'Jingle Bells',
            artist: 'Traditional',
            category: 'Holiday',
            bpm: 180,
            melody: [
                ['E4', 1], ['E4', 1], ['E4', 2], ['E4', 1], ['E4', 1], ['E4', 2],
                ['E4', 1], ['G4', 1], ['C4', 1], ['D4', 1], ['E4', 4],
                ['F4', 1], ['F4', 1], ['F4', 1], ['F4', 1], ['F4', 1], ['E4', 1], ['E4', 1], ['E4', 0.5], ['E4', 0.5],
                ['E4', 1], ['D4', 1], ['D4', 1], ['E4', 1], ['D4', 2], ['G4', 2],
                ['E4', 1], ['E4', 1], ['E4', 2], ['E4', 1], ['E4', 1], ['E4', 2],
                ['E4', 1], ['G4', 1], ['C4', 1], ['D4', 1], ['E4', 4],
                ['F4', 1], ['F4', 1], ['F4', 1], ['F4', 1], ['F4', 1], ['E4', 1], ['E4', 1], ['E4', 0.5], ['E4', 0.5],
                ['G4', 1], ['G4', 1], ['F4', 1], ['D4', 1], ['C4', 4]
            ]
        },
        {
            id: 'amazing-grace',
            title: 'Amazing Grace',
            artist: 'Traditional',
            category: 'Hymn',
            bpm: 80,
            melody: [
                ['G4', 1], ['C5', 2], ['E5', 0.5], ['C5', 0.5], ['E5', 2], ['D5', 1], ['C5', 2], ['A4', 1], ['G4', 2], ['G4', 1],
                ['C5', 2], ['E5', 0.5], ['C5', 0.5], ['E5', 2], ['D5', 1], ['G5', 3],
                ['E5', 1], ['G5', 2], ['E5', 0.5], ['G5', 0.5], ['E5', 2], ['C5', 1], ['C5', 2], ['A4', 1], ['G4', 2], ['G4', 1],
                ['C5', 2], ['E5', 0.5], ['C5', 0.5], ['E5', 2], ['D5', 1], ['C5', 3],
                ['G4', 1], ['C5', 2], ['E5', 0.5], ['C5', 0.5], ['E5', 2], ['D5', 1], ['C5', 2], ['A4', 1], ['G4', 2], ['G4', 1],
                ['C5', 2], ['E5', 0.5], ['C5', 0.5], ['E5', 2], ['D5', 1], ['C5', 3]
            ]
        },
        {
            id: 'mary-lamb',
            title: 'Mary Had a Little Lamb',
            artist: 'Traditional',
            category: 'Children',
            bpm: 110,
            melody: [
                ['E4', 1], ['D4', 1], ['C4', 1], ['D4', 1], ['E4', 1], ['E4', 1], ['E4', 2],
                ['D4', 1], ['D4', 1], ['D4', 2], ['E4', 1], ['G4', 1], ['G4', 2],
                ['E4', 1], ['D4', 1], ['C4', 1], ['D4', 1], ['E4', 1], ['E4', 1], ['E4', 1], ['E4', 1],
                ['D4', 1], ['D4', 1], ['E4', 1], ['D4', 1], ['C4', 4],
                ['E4', 1], ['D4', 1], ['C4', 1], ['D4', 1], ['E4', 1], ['E4', 1], ['E4', 2],
                ['D4', 1], ['D4', 1], ['D4', 2], ['E4', 1], ['G4', 1], ['G4', 2],
                ['E4', 1], ['D4', 1], ['C4', 1], ['D4', 1], ['E4', 1], ['E4', 1], ['E4', 1], ['E4', 1],
                ['D4', 1], ['D4', 1], ['E4', 1], ['D4', 1], ['C4', 4]
            ]
        },
        {
            id: 'london-bridge',
            title: 'London Bridge Is Falling Down',
            artist: 'Traditional',
            category: 'Children',
            bpm: 130,
            melody: [
                ['G4', 1.5], ['A4', 0.5], ['G4', 1], ['F4', 1], ['E4', 1], ['F4', 1], ['G4', 2],
                ['D4', 1], ['E4', 1], ['F4', 2], ['E4', 1], ['F4', 1], ['G4', 2],
                ['G4', 1.5], ['A4', 0.5], ['G4', 1], ['F4', 1], ['E4', 1], ['F4', 1], ['G4', 2],
                ['D4', 2], ['G4', 2], ['E4', 1], ['C4', 3],
                ['G4', 1.5], ['A4', 0.5], ['G4', 1], ['F4', 1], ['E4', 1], ['F4', 1], ['G4', 2],
                ['D4', 1], ['E4', 1], ['F4', 2], ['E4', 1], ['F4', 1], ['G4', 2],
                ['G4', 1.5], ['A4', 0.5], ['G4', 1], ['F4', 1], ['E4', 1], ['F4', 1], ['G4', 2],
                ['D4', 2], ['G4', 2], ['E4', 1], ['C4', 3]
            ]
        },
        {
            id: 'brahms-lullaby',
            title: "Brahms' Lullaby",
            artist: 'Brahms',
            category: 'Classical',
            bpm: 70,
            melody: [
                ['G4', 0.5], ['G4', 0.5], ['B4', 1.5], ['G4', 0.5], ['G4', 0.5], ['B4', 1.5],
                ['G4', 0.5], ['B4', 0.5], ['D5', 1], ['C5', 1], ['A4', 2],
                ['A4', 0.5], ['A4', 0.5], ['C5', 1.5], ['A4', 0.5], ['A4', 0.5], ['C5', 1],
                ['A4', 0.5], ['C5', 0.5], ['E5', 1], ['D5', 1], ['B4', 2],
                ['G4', 1], ['G4', 0.5], ['A4', 0.5], ['B4', 1], ['A4', 0.5], ['G4', 0.5],
                ['E4', 1], ['G4', 0.5], ['A4', 0.5], ['G4', 1], ['D4', 2],
                ['G4', 1], ['G4', 0.5], ['A4', 0.5], ['B4', 1], ['A4', 0.5], ['G4', 0.5],
                ['E5', 1], ['D5', 0.5], ['C5', 0.5], ['B4', 1], ['G4', 2]
            ]
        },
        {
            id: 'can-can',
            title: 'Can-Can (Galop Infernal)',
            artist: 'Offenbach',
            category: 'Classical',
            bpm: 200,
            melody: [
                ['E4', 0.5], ['E4', 0.5], ['E4', 0.5], ['E4', 0.5], ['E4', 0.5], ['E4', 0.5], ['E4', 0.5], ['E4', 0.5],
                ['E4', 0.5], ['F4', 0.5], ['G4', 0.5], ['G4', 0.5], ['G4', 0.5], ['A4', 0.5], ['G4', 0.5], ['F4', 0.5],
                ['E4', 0.5], ['E4', 0.5], ['E4', 0.5], ['E4', 0.5], ['E4', 0.5], ['E4', 0.5], ['E4', 0.5], ['E4', 0.5],
                ['E4', 0.5], ['D4', 0.5], ['C4', 0.5], ['C4', 0.5], ['D4', 0.5], ['E4', 0.5], ['F4', 0.5], ['D4', 0.5],
                ['E4', 1], ['C4', 1], ['E4', 1], ['G4', 1],
                ['C5', 1], ['G4', 1], ['E4', 1], ['C4', 1],
                ['D4', 1], ['E4', 1], ['F4', 1], ['D4', 1],
                ['E4', 1], ['D4', 1], ['C4', 2]
            ]
        },
        {
            id: 'when-saints',
            title: 'When the Saints Go Marching In',
            artist: 'Traditional',
            category: 'Gospel',
            bpm: 120,
            melody: [
                ['C4', 1], ['E4', 1], ['F4', 1], ['G4', 3], ['C4', 1], ['E4', 1], ['F4', 1], ['G4', 3],
                ['C4', 1], ['E4', 1], ['F4', 1], ['G4', 2], ['E4', 2], ['C4', 2], ['E4', 2], ['D4', 4],
                ['E4', 1], ['E4', 1], ['D4', 1], ['C4', 2], ['C4', 1], ['E4', 2], ['G4', 2], ['G4', 1], ['F4', 3],
                ['E4', 1], ['F4', 1], ['G4', 2], ['E4', 2], ['C4', 2], ['D4', 2], ['C4', 4],
                ['C4', 1], ['E4', 1], ['F4', 1], ['G4', 3], ['C4', 1], ['E4', 1], ['F4', 1], ['G4', 3],
                ['C4', 1], ['E4', 1], ['F4', 1], ['G4', 2], ['E4', 2], ['C4', 2], ['E4', 2], ['D4', 4]
            ]
        },
        {
            id: 'auld-lang-syne',
            title: 'Auld Lang Syne',
            artist: 'Traditional',
            category: 'Celebration',
            bpm: 100,
            melody: [
                ['G4', 1], ['C5', 1.5], ['C5', 0.5], ['C5', 1], ['E5', 1], ['D5', 1.5], ['C5', 0.5], ['D5', 1], ['E5', 0.5], ['D5', 0.5],
                ['C5', 1.5], ['C5', 0.5], ['E5', 1], ['G5', 1], ['A5', 3], ['A5', 1],
                ['G5', 1.5], ['E5', 0.5], ['E5', 1], ['C5', 1], ['D5', 1.5], ['C5', 0.5], ['D5', 1], ['E5', 0.5], ['D5', 0.5],
                ['C5', 1.5], ['A4', 0.5], ['A4', 1], ['G4', 1], ['C5', 3],
                ['G4', 1], ['C5', 1.5], ['C5', 0.5], ['C5', 1], ['E5', 1], ['D5', 1.5], ['C5', 0.5], ['D5', 1], ['E5', 0.5], ['D5', 0.5],
                ['C5', 1.5], ['C5', 0.5], ['E5', 1], ['G5', 1], ['A5', 3]
            ]
        },
        {
            id: 'greensleeves',
            title: 'Greensleeves',
            artist: 'Traditional',
            category: 'Folk',
            bpm: 100,
            melody: [
                ['A4', 1], ['C5', 2], ['D5', 1], ['E5', 1.5], ['F5', 0.5], ['E5', 1], ['D5', 2], ['B4', 1],
                ['G4', 1.5], ['A4', 0.5], ['B4', 1], ['C5', 2], ['A4', 1], ['A4', 1.5], ['G#4', 0.5], ['A4', 1], ['B4', 2], ['G#4', 1], ['E4', 3],
                ['A4', 1], ['C5', 2], ['D5', 1], ['E5', 1.5], ['F5', 0.5], ['E5', 1], ['D5', 2], ['B4', 1],
                ['G4', 1.5], ['A4', 0.5], ['B4', 1], ['C5', 1.5], ['B4', 0.5], ['A4', 1], ['G#4', 1.5], ['F#4', 0.5], ['G#4', 1], ['A4', 3],
                ['G5', 3], ['G5', 1.5], ['F5', 0.5], ['E5', 1], ['D5', 2], ['B4', 1],
                ['G4', 1.5], ['A4', 0.5], ['B4', 1], ['C5', 2], ['A4', 1], ['A4', 1.5], ['G#4', 0.5], ['A4', 1], ['B4', 2], ['G#4', 1], ['E4', 3]
            ]
        },
        {
            id: 'pachelbel-canon',
            title: 'Canon in D',
            artist: 'Pachelbel',
            category: 'Classical',
            bpm: 60,
            melody: [
                ['F#5', 2], ['E5', 2], ['D5', 2], ['C#5', 2], ['B4', 2], ['A4', 2], ['B4', 2], ['C#5', 2],
                ['F#5', 2], ['E5', 2], ['D5', 2], ['C#5', 2], ['B4', 2], ['A4', 2], ['B4', 2], ['C#5', 2],
                ['D5', 1], ['F#4', 1], ['A4', 1], ['G4', 1], ['F#4', 1], ['D4', 1], ['F#4', 1], ['E4', 1],
                ['D4', 1], ['B3', 1], ['D4', 1], ['A4', 1], ['G4', 1], ['B4', 1], ['A4', 1], ['G4', 1],
                ['F#4', 1], ['D4', 1], ['E4', 1], ['C#5', 1], ['D5', 1], ['F#5', 1], ['A5', 1], ['A4', 1],
                ['B4', 1], ['G4', 1], ['A4', 1], ['F#4', 1], ['D4', 1], ['D5', 1], ['D5', 0.5], ['C#5', 0.5], ['D5', 0.5], ['E5', 0.5]
            ]
        },
        {
            id: 'scarborough-fair',
            title: 'Scarborough Fair',
            artist: 'Traditional',
            category: 'Folk',
            bpm: 90,
            melody: [
                ['E4', 2], ['A4', 2], ['A4', 1], ['B4', 1], ['A4', 1], ['G4', 1], ['E4', 3],
                ['D4', 1], ['E4', 2], ['G4', 1], ['A4', 3], ['A4', 1],
                ['C5', 2], ['C5', 1], ['B4', 1], ['G4', 1], ['A4', 2], ['E4', 1], ['E4', 3], ['D4', 1],
                ['E4', 1], ['D4', 1], ['D4', 1], ['C4', 1], ['A3', 3],
                ['E4', 2], ['A4', 2], ['A4', 1], ['B4', 1], ['A4', 1], ['G4', 1], ['E4', 3],
                ['D4', 1], ['E4', 2], ['G4', 1], ['A4', 3], ['A4', 1],
                ['C5', 2], ['C5', 1], ['B4', 1], ['G4', 1], ['A4', 2], ['E4', 1], ['E4', 3]
            ]
        }
    ];

    // ===================== GAME STATE =====================
    const DURATIONS = [1, 2, 4, 7, 11, 16];
    const MAX_GUESSES = 6;

    let synth = new PianoSynth();
    let mode = 'daily'; // 'daily' or 'practice'
    let currentSong = null;
    let attempt = 0;
    let guesses = [];
    let gameStatus = 'playing';
    let selectedSong = null;
    let isPlaying = false;
    let waveformInterval = null;
    let playbackTimeout = null; // Track setTimeout to prevent race conditions

    // ===================== INITIALIZATION =====================
    document.addEventListener('DOMContentLoaded', () => {
        createWaveform();
        setupAutocomplete();
        loadGame();
    });

    function loadGame() {
        if (mode === 'daily') {
            currentSong = getDailySong();
            loadDailyState();
        } else {
            currentSong = getRandomSong();
            resetGame();
        }
        renderGame();
    }

    function getDailySong() {
        const epoch = Date.UTC(2025, 0, 1);
        const now = new Date();
        const todayUTC = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate());
        const dayNum = Math.floor((todayUTC - epoch) / 86400000) + 1;
        const idx = Math.abs(hashCode(`melody-${dayNum}`)) % SONGS.length;
        return { ...SONGS[idx], dayNum };
    }

    function hashCode(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = ((hash << 5) - hash) + str.charCodeAt(i);
            hash |= 0;
        }
        return hash;
    }

    function getRandomSong() {
        return { ...SONGS[Math.floor(Math.random() * SONGS.length)], dayNum: null };
    }

    function resetGame() {
        attempt = 0;
        guesses = [];
        gameStatus = 'playing';
        selectedSong = null;
        document.getElementById('search-input').value = '';
        document.getElementById('btn-submit').disabled = true;
    }

    // ===================== SAVE/LOAD STATE =====================
    // Use UTC consistently to avoid timezone bugs around midnight
    function getTodayKey() {
        const d = new Date();
        return `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(2, '0')}-${String(d.getUTCDate()).padStart(2, '0')}`;
    }

    function loadDailyState() {
        try {
            const saved = JSON.parse(localStorage.getItem('mm-daily') || '{}');
            if (saved.date === getTodayKey()) {
                // Validate attempt is valid number in range
                attempt = (typeof saved.attempt === 'number' &&
                          saved.attempt >= 0 &&
                          saved.attempt <= MAX_GUESSES)
                          ? Math.floor(saved.attempt) : 0;

                // Validate guesses array structure
                guesses = Array.isArray(saved.guesses)
                    ? saved.guesses.filter(g =>
                        g && typeof g === 'object' &&
                        (g.type === 'skip' || g.type === 'guess') &&
                        typeof g.correct === 'boolean'
                      ).slice(0, MAX_GUESSES)
                    : [];

                // Validate gameStatus enum
                gameStatus = ['playing', 'won', 'lost'].includes(saved.status)
                    ? saved.status : 'playing';

                // Show result modal if game already completed
                if (gameStatus !== 'playing') {
                    setTimeout(showResultModal, 500);
                }
            } else {
                resetGame();
            }
        } catch { resetGame(); }
    }

    function saveDailyState() {
        if (mode !== 'daily') return;
        try {
            localStorage.setItem('mm-daily', JSON.stringify({
                date: getTodayKey(),
                attempt,
                guesses,
                status: gameStatus
            }));
        } catch {}
    }

    function loadStats() {
        try {
            return JSON.parse(localStorage.getItem('mm-stats') || '{}');
        } catch { return {}; }
    }

    function saveStats(won, attempts) {
        const stats = loadStats();
        const today = getTodayKey();
        if (stats.lastPlayed === today) return;

        stats.played = (stats.played || 0) + 1;
        if (won) {
            stats.won = (stats.won || 0) + 1;
            const wasYesterday = isYesterday(stats.lastPlayed);
            stats.streak = wasYesterday ? (stats.streak || 0) + 1 : 1;
            stats.maxStreak = Math.max(stats.maxStreak || 0, stats.streak);
            stats.dist = stats.dist || [0,0,0,0,0,0];
            stats.dist[attempts - 1]++;
        } else {
            stats.streak = 0;
        }
        stats.lastPlayed = today;

        try { localStorage.setItem('mm-stats', JSON.stringify(stats)); } catch {}
    }

    function isYesterday(dateStr) {
        if (!dateStr) return false;
        const now = new Date();
        const yesterday = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - 1));
        return dateStr === `${yesterday.getUTCFullYear()}-${String(yesterday.getUTCMonth() + 1).padStart(2, '0')}-${String(yesterday.getUTCDate()).padStart(2, '0')}`;
    }

    // ===================== AUDIO PLAYBACK =====================
    async function playSnippet() {
        // Cancel any pending playback timeout
        if (playbackTimeout) {
            clearTimeout(playbackTimeout);
            playbackTimeout = null;
        }

        if (isPlaying) {
            synth.stop();
            stopWaveform();
            isPlaying = false;
            updatePlayBtn();
            return;
        }

        if (!synth.supported) {
            showToast('Audio not supported in this browser');
            return;
        }

        const duration = DURATIONS[Math.max(0, Math.min(attempt, MAX_GUESSES - 1))];
        isPlaying = true;
        updatePlayBtn();
        startWaveform();

        const actualDuration = await synth.playMelody(currentSong.melody, currentSong.bpm, duration);

        playbackTimeout = setTimeout(() => {
            if (isPlaying) { // Only reset if still playing (not manually stopped)
                isPlaying = false;
                updatePlayBtn();
                stopWaveform();
            }
            playbackTimeout = null;
        }, actualDuration * 1000 + 100);
    }

    function updatePlayBtn() {
        const btn = document.getElementById('play-btn');
        const icon = document.getElementById('play-icon');
        btn.classList.toggle('playing', isPlaying);
        icon.innerHTML = isPlaying
            ? '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>'
            : '<polygon points="5,3 19,12 5,21"/>';
    }

    function setVolume(v) {
        synth.setVolume(v / 100);
    }

    // ===================== WAVEFORM =====================
    function createWaveform() {
        const container = document.getElementById('waveform');
        container.innerHTML = '';
        for (let i = 0; i < 40; i++) {
            const bar = document.createElement('div');
            bar.className = 'wave-bar';
            bar.style.height = '4px';
            container.appendChild(bar);
        }
    }

    function startWaveform() {
        // Clear any existing interval first to prevent multiple intervals
        if (waveformInterval) {
            clearInterval(waveformInterval);
        }
        const bars = document.querySelectorAll('.wave-bar');
        waveformInterval = setInterval(() => {
            bars.forEach(bar => {
                bar.style.height = (Math.random() * 60 + 8) + 'px';
            });
        }, 50);
    }

    function stopWaveform() {
        if (waveformInterval) {
            clearInterval(waveformInterval);
            waveformInterval = null; // Clear reference
        }
        document.querySelectorAll('.wave-bar').forEach(bar => bar.style.height = '4px');
    }

    // ===================== GAME LOGIC =====================
    function submitGuess() {
        if (!selectedSong || gameStatus !== 'playing') return;

        // Prevent duplicate guesses of the same wrong song
        const alreadyGuessed = guesses.some(g => g.type === 'guess' && g.title === selectedSong.title);
        if (alreadyGuessed) {
            showToast('You already guessed this song!');
            return;
        }

        const isCorrect = selectedSong.id === currentSong.id;
        guesses.push({ title: selectedSong.title, artist: selectedSong.artist, correct: isCorrect, type: 'guess' });

        if (isCorrect) {
            gameStatus = 'won';
            if (mode === 'daily') saveStats(true, attempt + 1);
        } else {
            attempt++;
            if (attempt >= MAX_GUESSES) {
                gameStatus = 'lost';
                if (mode === 'daily') saveStats(false, MAX_GUESSES);
            }
        }

        selectedSong = null;
        document.getElementById('search-input').value = '';
        document.getElementById('btn-submit').disabled = true;
        document.getElementById('autocomplete').classList.remove('show');

        saveDailyState();
        renderGame();

        if (gameStatus !== 'playing') {
            setTimeout(showResultModal, 300);
        }
    }

    function skipGuess() {
        if (gameStatus !== 'playing') return;

        guesses.push({ title: null, artist: null, correct: false, type: 'skip' });
        attempt++;

        if (attempt >= MAX_GUESSES) {
            gameStatus = 'lost';
            if (mode === 'daily') saveStats(false, MAX_GUESSES);
        }

        saveDailyState();
        renderGame();

        if (gameStatus !== 'playing') {
            setTimeout(showResultModal, 300);
        }
    }

    // ===================== RENDERING =====================
    function renderGame() {
        renderTimeline();
        renderGuesses();
        renderPlayerInfo();
        renderInputSection();
    }

    function renderTimeline() {
        const markers = document.getElementById('timeline-markers');
        const progress = document.getElementById('timeline-progress');
        const label = document.getElementById('timeline-label');

        markers.innerHTML = '';
        const widths = DURATIONS.map((d, i) => (d / 16) * 100);

        let cumulative = 0;
        for (let i = 0; i < MAX_GUESSES; i++) {
            const seg = document.createElement('div');
            seg.className = 'timeline-segment';
            seg.style.width = widths[i] + '%';

            if (i < guesses.length) {
                seg.classList.add(guesses[i].correct ? 'correct' : guesses[i].type === 'skip' ? 'skipped' : 'used');
            }
            markers.appendChild(seg);
            cumulative += widths[i];
        }

        const currentDuration = DURATIONS[Math.min(attempt, MAX_GUESSES - 1)];
        progress.style.width = (currentDuration / 16) * 100 + '%';
        label.textContent = formatTime(currentDuration);
    }

    function formatTime(sec) {
        return sec < 60 ? `0:${String(sec).padStart(2, '0')}` : `${Math.floor(sec/60)}:${String(sec%60).padStart(2, '0')}`;
    }

    function renderGuesses() {
        const container = document.getElementById('guesses');
        container.innerHTML = '';

        for (let i = 0; i < MAX_GUESSES; i++) {
            const g = guesses[i];
            const row = document.createElement('div');
            row.className = 'guess-row';

            if (g) {
                row.classList.add(g.correct ? 'correct' : g.type === 'skip' ? 'skipped' : 'wrong');
            } else {
                row.classList.add('empty');
            }

            const num = document.createElement('div');
            num.className = 'guess-num';
            num.textContent = i + 1;

            const text = document.createElement('div');
            text.className = 'guess-text';
            if (g) {
                text.textContent = g.type === 'skip' ? 'Skipped' : g.title;
            } else {
                text.textContent = i === attempt && gameStatus === 'playing' ? 'Your guess...' : '';
                text.classList.add('empty');
            }

            row.appendChild(num);
            row.appendChild(text);
            container.appendChild(row);
        }
    }

    function renderPlayerInfo() {
        document.getElementById('attempt-num').textContent = Math.min(attempt + 1, MAX_GUESSES);
        document.getElementById('duration-sec').textContent = DURATIONS[Math.min(attempt, MAX_GUESSES - 1)];
    }

    function renderInputSection() {
        const section = document.getElementById('input-section');
        section.style.display = gameStatus === 'playing' ? 'block' : 'none';
    }

    // ===================== AUTOCOMPLETE =====================
    // HTML escape function to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function setupAutocomplete() {
        const input = document.getElementById('search-input');
        const dropdown = document.getElementById('autocomplete');
        let selectedIdx = -1;

        // Use event delegation to prevent memory leak from adding listeners on every keystroke
        dropdown.addEventListener('click', (e) => {
            const item = e.target.closest('.ac-item');
            if (item && item.dataset.id) {
                selectSong(item.dataset.id);
            }
        });

        input.addEventListener('input', () => {
            const q = input.value.toLowerCase().trim();
            if (q.length < 2) {
                dropdown.classList.remove('show');
                return;
            }

            const matches = SONGS.filter(s =>
                s.title.toLowerCase().includes(q) || s.artist.toLowerCase().includes(q)
            ).slice(0, 6);

            if (!matches.length) {
                dropdown.classList.remove('show');
                return;
            }

            // Use escapeHtml to prevent XSS
            dropdown.innerHTML = matches.map((s, i) => `
                <div class="ac-item${i === selectedIdx ? ' selected' : ''}" data-id="${escapeHtml(s.id)}">
                    <div class="ac-title">${escapeHtml(s.title)}</div>
                    <div class="ac-artist">${escapeHtml(s.artist)}</div>
                </div>
            `).join('');

            dropdown.classList.add('show');
            selectedIdx = -1;
            // No more addEventListener here - using event delegation above
        });

        input.addEventListener('keydown', e => {
            const items = dropdown.querySelectorAll('.ac-item');
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIdx = Math.min(selectedIdx + 1, items.length - 1);
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIdx = Math.max(selectedIdx - 1, 0);
                updateSelection(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIdx >= 0 && items[selectedIdx]) {
                    selectSong(items[selectedIdx].dataset.id);
                } else if (selectedSong) {
                    submitGuess();
                }
            } else if (e.key === 'Escape') {
                dropdown.classList.remove('show');
            }
        });

        function updateSelection(items) {
            items.forEach((item, i) => item.classList.toggle('selected', i === selectedIdx));
        }

        document.addEventListener('click', e => {
            if (!e.target.closest('.search-wrapper')) {
                dropdown.classList.remove('show');
            }
        });
    }

    function selectSong(id) {
        const song = SONGS.find(s => s.id === id);
        if (!song) return;
        selectedSong = song;
        document.getElementById('search-input').value = song.title;
        document.getElementById('autocomplete').classList.remove('show');
        document.getElementById('btn-submit').disabled = false;
    }

    // ===================== MODE SWITCHING =====================
    function setMode(m) {
        mode = m;
        document.getElementById('tab-daily').classList.toggle('active', m === 'daily');
        document.getElementById('tab-practice').classList.toggle('active', m === 'practice');
        loadGame();
    }

    // ===================== MODALS =====================
    function showResultModal() {
        const modal = document.getElementById('result-modal');
        const content = document.getElementById('result-modal-content');

        content.classList.remove('win', 'lose');
        content.classList.add(gameStatus === 'won' ? 'win' : 'lose');

        document.getElementById('result-title').textContent = gameStatus === 'won' ? 'ðŸŽ‰ You got it!' : 'ðŸ˜¢ Better luck next time';
        document.getElementById('result-song-title').textContent = currentSong.title;
        document.getElementById('result-song-artist').textContent = currentSong.artist;
        document.getElementById('result-emoji').textContent = guesses.map(g => g.correct ? 'ðŸŸ©' : g.type === 'skip' ? 'â¬›' : 'ðŸŸ¥').join('');

        const stats = loadStats();
        document.getElementById('result-played').textContent = stats.played || 0;
        document.getElementById('result-win').textContent = stats.played ? Math.round((stats.won || 0) / stats.played * 100) + '%' : '0%';
        document.getElementById('result-streak').textContent = stats.streak || 0;

        // Show Play Again button only for practice mode
        document.getElementById('btn-play-again').style.display = mode === 'practice' ? 'block' : 'none';

        modal.classList.add('show');
    }

    function closeResultModal() {
        document.getElementById('result-modal').classList.remove('show');
    }

    function playAgain() {
        closeResultModal();
        if (mode === 'practice') {
            currentSong = getRandomSong();
            resetGame();
            renderGame();
        }
    }

    function showStats() {
        const stats = loadStats();
        document.getElementById('stats-played').textContent = stats.played || 0;
        document.getElementById('stats-win').textContent = stats.played ? Math.round((stats.won || 0) / stats.played * 100) + '%' : '0%';
        document.getElementById('stats-streak').textContent = stats.streak || 0;
        document.getElementById('stats-max').textContent = stats.maxStreak || 0;

        const dist = stats.dist || [0,0,0,0,0,0];
        const max = Math.max(...dist, 1);
        document.getElementById('stats-distribution').innerHTML = dist.map((c, i) => `
            <div style="display: flex; align-items: center; margin: 4px 0;">
                <span style="width: 20px; text-align: center;">${i + 1}</span>
                <div style="flex: 1; height: 20px; background: var(--bg-input); border-radius: 4px; margin-left: 8px; overflow: hidden;">
                    <div style="width: ${Math.max(c / max * 100, 8)}%; height: 100%; background: var(--accent); display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 0.75rem;">${c}</div>
                </div>
            </div>
        `).join('');

        document.getElementById('stats-modal').classList.add('show');
    }

    function closeStatsModal() {
        document.getElementById('stats-modal').classList.remove('show');
    }

    function showHelp() {
        document.getElementById('help-modal').classList.add('show');
    }

    function closeHelpModal() {
        document.getElementById('help-modal').classList.remove('show');
    }

    // ===================== SHARING =====================
    function shareResult() {
        const dayNum = currentSong.dayNum || 'âˆž';
        const attempts = gameStatus === 'won' ? guesses.length : 'X';
        const emoji = guesses.map(g => g.correct ? 'ðŸŸ©' : g.type === 'skip' ? 'â¬›' : 'ðŸŸ¥').join('');
        const text = `ðŸŽµ Melody Master #${dayNum}\n${attempts}/${MAX_GUESSES}\n\n${emoji}`;

        if (navigator.share) {
            navigator.share({ text }).catch(() => copyText(text));
        } else {
            copyText(text);
        }
    }

    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast('Copied to clipboard!');
        }).catch(() => {
            showToast('Could not copy');
        });
    }

    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
    }
    </script>
</body>
</html>
